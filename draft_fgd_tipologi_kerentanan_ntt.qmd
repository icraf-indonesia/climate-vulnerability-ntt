---
title: "[DRAFT] Tipologi Kerentanan Iklim pada Penghidupan Berbasis Pertanian: Provinsi Nusa Tenggara Timur"
format: 
  html:
    toc: true
    number-sections: true
    embed-resources: false
editor: visual
execute:
  echo: false
project:
  type: website
  output-dir: docs
editor_options: 
  chunk_output_type: inline
comments:
  utterances:
    repo: icraf-indonesia/climate-vulnerability-ntt
---

```{r session info}
# sessionInfo()
# Sys.getenv()
# .libPaths()

# If the sessioninfo package is available, 
# it provides output that is easier to read,
# and can write its results to a file
sessioninfo:::session_info(to_file = "quarto-session-info-output.txt")

```


```{r load library}
#| warning: false
#| message: false
library(tibble)
library(targets)
library(tarchetypes)
library(ggplot2)
library(leaflet)
library(gt)
library(sf)
library(dplyr)
library(plotly)
library(readr)
```

# Pendahuluan

::: panel-tabset
## Abstrak

Penghidupan berbasis pertanian kini makin rentan terhadap perubahan iklim, tetapi informasi mengenai potensi resiko dan kebutuhan adaptasi mereka masih sangat terbatas. Draft dokumen ini disusun untuk mengisi kekosongan ini dengan mengevaluasi berbagai jenis kerentanan yang mempengaruhi mata pencaharian berbasis pertanian di tingkat provinsi. Kami melakukan penilaian kerentanan untuk mengidentifikasi risiko serta penyebabnya, dan potensi adaptasi, dengan fokus pada peningkatan taraf hidup, keberlanjutan produksi komoditas-komoditas kunci, dan pengelolaan lahan secara menyeluruh.

Mengingat tingginya keanekaragaman lanskap di Provinsi Nusa Tenggara Timur, kami memfokuskan perhatian pada kecamatan-kecamatan dengan fitur biofisik dan sosial-ekonomi yang mirip. Ini membantu kami mempermudah tugas dalam mengidentifikasi risiko yang identik antar kecamatan. Kami mendefinisikan area-area homogen ini, atau 'tipologi,' dengan menggunakan pengelompokan K-means. Pengelompokan ini didasarkan pada komposit dari indikator biofisik dan sosial-ekonomi. Untuk mempermudah proses pengelompokan, kami menggunakan analisis PCA untuk menyederhanakan dimensi data.

## Tujuan

-   Analisis ini bertujuan untuk mengidentifikasi 'tipologi' kecamatan-kecamatan, yang memiliki karakter sosial-ekonomi dan lingkungan yang mirip di Provinsi Nusa Tenggara Timur, dengan menggunakan pengelompokan K-means pada data yang disederhanakan oleh PCA.

-   Tipologi tersebut kemudian digunakan untuk mendeskripsikan konteks kerentanan penghidupan berbasis pertanian akibat perubahan iklim di Provinsi Nusa Tenggara Timur dan potensi intervensi untuk meningkatkan ketahanan terhadap perubahan iklim.
:::

# Deskripsi wilayah & Metodologi

::: panel-tabset
## Deskripsi Nusa Tenggara Timur

Provinsi Nusa Tenggara Timur, yang terletak di sisi timur Provinsi Sulawesi Selatan, memiliki luas wilayah sebesar xxxx kilometer persegi. Kabupaten ini memiliki dataran rendah yang subur. Terdapat kawasan xxxxxxxxx. Daerah ini menerima hujan sekitar xxxxxx, yang merupakan ciri khas iklim xxx.

Provinsi Nusa Tenggara Timur merupakan rumah bagi sekitar xxxx penduduk berdasarkan data tahun 2022. Kabupaten ini memiliki tingkat ketimpangan ekonomi yang xxx, seperti yang tercermin dalam rasio Gini senilai xxxxx. NTT mencatatkan angkaxxx untuk Indeks Pembangunan Manusia (IPM) di tahun yang sama.

Produk Domestik Bruto (PDB, Atas Dasar Harga Berlaku) untuk Provinsi Nusa Tenggara Timur adalah xxxx triliun Rupiah Indonesia pada tahun 2022. Hal ini menempatkan xxx sebagai Kabupaten dengan perputaran ekonomi terbesar kedua di NTT.

Pada tahun 2022, sektor pertanian di Provinsi Nusa Tenggara Timur memainkan peran penting dalam perekonomian lokal, dengan kontribusi sebesar xxxx terhadap total Produk Domestik Regional Bruto (PDRB). Kabupaten ini terutama dikenal sebagai penghasil xxxx terkemuka di xxx, dengan total produksi hampir mencapai xxx juta ton. Selain xxx, produksi xxxx juga mencapai angka yang signifikan, yaitu sekitar xxxx ribu ton. Dalam konteks pertanian berbasis pohon, terdapat beberapa komoditas utama seperti xxx dengan produksi xxxx ton, xxxx sebanyak xxxx ton, dan zzzz yang mencapai xxxx ton. Sektor ini menyerap tenaga kerja dari sekitar xxxxx petani. Di samping itu, hutan di wilayah ini turut menyumbang sumber daya berharga seperti xxxx dan xxxx Sektor xxxx xxxxx juga memiliki peran penting dalam mendukung ekonomi lokal.

## Daftar Variabel

**Unit analisis terkecil**: Kecamatan
```{r}
#| warning: false
#| message: false
read_csv("data/List_variable_bahasa.csv") |> 
  gt(rowname_col = "No")
```


## Skema Teknis Pembuatan Tipologi

![](data/workflow.svg){height="1200" width="800" fig-align="center"}

## Intisari Hasil PCA

```{r PCA Summary}
#| warning: false
#| message: false
pca_summary <- tar_read(pca_result) |> 
  summary() 

# Extracting the relevant parts of the summary
std_dev <- pca_summary$importance["Standard deviation", ]
prop_variance <- pca_summary$importance["Proportion of Variance", ]
cumul_prop <- pca_summary$importance["Cumulative Proportion", ]

# Creating a data frame
pca_df <- tibble(
  PC = names(std_dev),
  StandardDeviation = std_dev,
  ProportionOfVariance = prop_variance,
  CumulativeProportion = cumul_prop
)

pca_df |> 
  gt() |> 
  tab_header(
    title = "Intisari Analisis Komponen Utama (PCA)",
    subtitle = "Tingkat Kepentingan Komponen"
  ) |> 
  cols_label(
    PC = "Komponen",
    StandardDeviation = "Standar Deviasi",
    ProportionOfVariance = "Proporsi Variansi",
    CumulativeProportion = "Proporsi Kumulatif"
  ) |> 
  fmt_number(
    columns = vars(StandardDeviation, ProportionOfVariance, CumulativeProportion),
    decimals = 4
  ) |> 
  tab_options(
    heading.background.color = "lightblue",
    column_labels.font.size = "small"
  )
```

------------------------------------------------------------------------

### Interpretasi Komponen Utama (PCs)

**PC1: Predominan Demografi dan Jenis Tutupan Lahan** (`r pca_df[1,3]*100`%) ![](output/Loadings%20for%20PC1.png)

**PC2: Predominan Bahaya Hidrologis dan Akses terhadap Air** (`r pca_df[2,3]*100`%) ![](output/Loadings%20for%20PC2.png)

**PC3: Predominan Karakter Iklim** (`r pca_df[3,3]*100`%) ![](output/Loadings%20for%20PC3.png)

**PC4: Predominan Infrastruktur Mitigasi Bencana dan Akses Terhadap Air** (`r pca_df[4,3]*100`%) ![](output/Loadings%20for%20PC4.png)

**PC5: Predominan Akses Terhadap Air (Irigasi)** (`r pca_df[5,3]*100`%) ![](output/Loadings%20for%20PC5.png)

## Hasil Pengelompokan K-means

### Diagram pencar 3D tipologi kecamatan-kecamatan di Provinsi Nusa Tenggara Timur

-   Sumbu x,y dan z dari diagram pencar merupakan tiga komponen utama teratas dari hasil PCA.
    -   **PC1: Predominan Demografi dan Jenis Tutupan Lahan**
    -   **PC2: Predominan Bahaya Hidrologis dan Akses terhadap Air**
    -   **PC3: Predominan Karakter Iklim**
-   Tiap-titiknya mewakili sebuah kecamatan di Provinsi Nusa Tenggara Timur
-   Titik yang berwarna sama berarti tergolong dalam tipologi yang sama.

```{r K-means cluster}
#| warning: false
#| message: false
tar_load(plot_3d_scatter)
plot_3d_scatter
```

### Cluster Validation

::: {layout-ncol="2"}
```{r wss plot}
#| warning: false
#| message: false
tar_load(elbow_plot)

elbow_plot
```

Titik 'siku' dari sebuah elbow plot adalah titik di mana menambahkan penambahan jumlah kluster tidak banyak memberikan tambahan informasi baru.

```{r shillouete}
#| warning: false
#| message: false

tar_load(silhouette_plot)

silhouette_plot
```

Plot siluet yang mendekati +1 menunjukkan pengelompokan yang baik, sementara nilai yang mendekati 0 atau nilai negatif menunjukkan pengelompokan yang tumpang tindih atau tidak baik.
:::

## Tabel Interpretasi Klaster

```{r Tabel Intisari Klaster Sulsel}
#| warning: false
#| message: false
tabel_intisari <- tar_read(summary_table_kec)|> 
  #dplyr::select(-Kepulauan) |> 
  dplyr::mutate(variable = dplyr::case_when(
    variable == "annual_mean_prec" ~ "curah hujan rata-rata tahunan",
    variable == "annual_mean_temp" ~ "suhu rata-rata tahunan",
    variable == "arable_land_percent" ~ "persentase lahan pertanian",
    variable == "aridity_index" ~ "indeks kekeringan",
    variable == "distance_to_burned_area" ~ "jarak ke area terbakar",
    variable == "distance_to_commodity_processing_factory" ~ "jarak ke pabrik pengolahan komoditas",
    variable == "distance_to_deforestation" ~ "jarak ke area deforestasi",
    variable == "distance_to_forest" ~ "jarak ke hutan",
    variable == "distance_to_plantation" ~ "jarak ke perkebunan",
    variable == "distance_to_plantation_concession" ~ "jarak ke konsesi perkebunan",
    variable == "distance_to_river" ~ "jarak ke sungai",
    variable == "distance_to_road" ~ "jarak ke jalan",
    variable == "erosion_risk_t_ha_1_yr_1" ~ "risiko erosi t ha per tahun",
    variable == "indeks_bahaya_banjir" ~ "indeks risiko banjir",
    variable == "indeks_bahaya_longsor" ~ "indeks risiko longsor",
    variable == "irrigated_land" ~ "lahan irigasi",
    variable == "percentage_deforestation_area_size" ~ "persentase ukuran area deforestasi",
    variable == "percentage_of_agricultural_area_small_holder_in_the_village" ~ "persentase area pertanian skala kecil",
    variable == "percentage_of_plantation_area_per_sub_district" ~ "persentase area perkebunan per kecamatan",
    variable == "prec_change" ~ "perubahan curah hujan",
    variable == "rasio_40pers_ekon_rendah_rt" ~ "rasio 40 persen ekonomi rendah RT",
    variable == "rasio_faskes_1" ~ "rasio fasilitas kesehatan 1",
    variable == "rasio_minimarket_swalayan" ~ "rasio minimarket swalayan",
    variable == "rasio_pt" ~ "rasio perguruan tinggi",
    variable == "rasio_rs" ~ "rasio rumah sakit",
    variable == "temp_change" ~ "perubahan suhu",
    variable == "total_kk_berdasarkan_pengguna_dan_non_pengguna_listâ€¦" ~ "total KK berdasarkan pengguna dan non pengguna listrik",
    variable == "wet_months" ~ "bulan basah",
    # Add other translations here
    TRUE ~ variable # default action to keep the original name if not matched
  )) |> 
  dplyr::mutate(variable = gsub("_", " ", variable)) |> 
  dplyr::rename(Variabel = variable)
  
tabel_intisari_formatted <- tabel_intisari |> 
  gt()|>
  tab_header(
    title = "Karakteristik Sosio-ekonomi dan Lingkungan di Berbagai Kelas Tipologi: Analisis Rata-rata dan Standar Deviasi") |> 
    opt_align_table_header(align = "left")

tabel_intisari_formatted
```

::: callout-tip
### Apa itu rata-rata dan standar deviasi?

**Rata-Rata**

Rata-rata adalah angka yang sering kita gunakan untuk mengetahui gambaran umum dari sekelompok data. Misalnya, jika rata-rata jarak ke jalan terdekat di daerah urban cuma 0,24 km, ini menunjukkan bahwa umumnya daerah tersebut dekat dengan jalan raya.

**Standar Deviasi**

Standar deviasi (SD) memberitahu kita seberapa besar variasi atau perbedaan antar angka dalam sekelompok data. Semakin tinggi SD, makin besar juga variasinya. Misalnya, rata-rata jarak ke jalan terdekat di daerah urban adalah 0,24 km dengan SD 0,45 km. Ini artinya yang sangat dekat dengan jalan, tetapi juga ada yang jauh---bahkan lebih dari dua kali lipat dari rata-rata.

Nilai standar deviasi (SD) yang besar, seperti contoh diatas, menjadi indikasi bahwa, rata-rata mungkin tidak memberikan gambaran yang mewakili suatu tipologi. Dalam hal ini, standar deviasi memberikan konteks tambahan yang penting untuk memahami sejauh mana data bervariasi.
:::

## Tabel Interpretasi Klaster (Berwarna)

Kode warna pada tabel dibawah menunjukkan rentang nilai dari variabel yang diberikan untuk masing-masing tipe wilayah. Warna biru gelap menunjukkan nilai yang lebih tinggi, sementara warna yang lebih merah terang menunjukkan nilai yang lebih rendah.

```{r color coded table}
#| warning: false
#| message: false

tar_read(summary_table_color)

```
:::

# Hasil & Interpretasi Sementara (Draft)

**Tipologi Kerentanan Terhadap Perubahan Iklim pada Penghidupan Berbasis Pertanian di Provinsi Nusa Tenggara Timur**

::: panel-tabset
### Peta Tipologi

```{r Map}
#| warning: false
#| message: false

source("R/functions.R")

tp_map <- create_leaflet_map(clusters_kec = "output/tipologi_ntt_.shp", cluster_lookup = "data/cluster_names.csv")

tp_map
```

### Komposisi Luas Wilayah

```{r komposisi kecamatan}
#| warning: false
#| message: false

# intisari_desk_kec <- readr::read_csv("data/interpretasi_tipologi_bone.csv") |> 
#   dplyr::mutate(`Kepadatan RT` = `Luas (Ha)`/`Rumah Tangga`) |> 
#   mutate(color_pal = c( "#377EB8","#E41A1C","#FF7F00" ,  "#4DAF4A", "black" ))
# 
# fig_luas <- intisari_desk_kec |> 
#   filter(Nama != "Total") |> 
#   plot_ly( labels = ~Nama, values = ~`Luas (Ha)`,
#                marker = list(colors = ~color_pal))|> 
#   add_pie(hole = 0.6) |> 
#   layout(title = "Komposisi Luas Wilayah (Ha)",
#          xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
#          yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))  
# 
# # Show the plot
# fig_luas
```

### Komposisi Demografi

```{r donat RT}
# Create the plot for Jumlah RT

tar_load(clusters_kec_tbl)
tar_load(df_raw)
tar_load(cluster_lookup)

Total_KK <- clusters_kec_tbl |> ungroup() |>
  select("cluster") |>
  bind_cols(df_raw) |>
  left_join(cluster_lookup, by = "cluster") |>
  select(name, total_kk) |>
  group_by(name) |>
  summarise(total_kk = sum(total_kk)) |> 
  rename(Nama = name, `Rumah Tangga` = total_kk) |> 
  mutate(color_pal = c("#E41A1C", "#377EB8", "#4DAF4A", "purple", "#FF7F00", "yellow"))


fig_RT <- Total_KK |>
  plot_ly(
    labels = ~ Nama,
    values = ~ `Rumah Tangga`,
     marker = list(colors = ~color_pal)
  ) |>
  add_pie(hole = 0.6) |>
  layout(
    title = "Jumlah Rumah Tangga",
    xaxis = list(
      showgrid = FALSE,
      zeroline = FALSE,
      showticklabels = FALSE
    ),
    yaxis = list(
      showgrid = FALSE,
      zeroline = FALSE,
      showticklabels = FALSE
    )
  )  

# Show the plot
fig_RT
```

### **1. Cluster 1: Sentra Niaga dan Jasa**

**Karakteristik**

-   1

-   2

-   3

-   4

-   5

-   6

**Tantangan Utama**

-   a

-   b

-   c

-   d

### **2. Cluster 2**

**Karakteristik**

-   1

-   2

-   3

-   4

-   5

-   6

**Tantangan Utama**

-   a

-   b

-   c

-   d

### **3. Cluster 3**

-   1

-   2

-   3

-   4

-   5

-   6

**Tantangan Utama**

-   a

-   b

-   c

-   d

### **4. Cluster 4**

-   1

-   2

-   3

-   4

-   5

-   6

**Tantangan Utama**

-   a

-   b

-   c

-   d
:::
